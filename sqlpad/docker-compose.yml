services:
  sqlpad:
    image: sqlpad/sqlpad:7.4.1
    container_name: sqlpad
    hostname: sqlpad
    restart: unless-stopped
    labels:
      "docker-prometheus-exporter.metric.container_health.enabled": "true"

    # Security hardening
    # security_opt:
    #   - no-new-privileges:true
    #   - seccomp=seccomp.json
    # cap_drop:
    #   - ALL
    # tmpfs:
    #   - /tmp:size=256M,noexec,nosuid,nodev

    # No external ports - accessed via nginx reverse proxy

    volumes:
      - sqlpad-data:/var/lib/sqlpad

    env_file:
      - ./config/sqlpad.env

    # Resource limits
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: "2"
        reservations:
          memory: 128M
          cpus: "0.25"

    # Health check
    healthcheck:
      test: ["CMD-SHELL", "node -e \"const http = require('http'); const req = http.request({hostname:'127.0.0.1',port:3000,path:'/boroda/sqlpad/api/app',timeout:5000}, res => process.exit(res.statusCode === 200 ? 0 : 1)); req.on('error', () => process.exit(1)); req.end();\""]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

    networks:
      - docker

volumes:
  sqlpad-data:
    name: sqlpad-data
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /app/docker/volumes/sqlpad-data

networks:
  docker:
    external: true
