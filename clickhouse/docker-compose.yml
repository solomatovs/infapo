services:
  ch01:
    image: clickhouse/clickhouse-server:26.1
    container_name: ch01
    hostname: ch01
    restart: unless-stopped
    labels:
      "docker-prometheus-exporter.metric.container_health.enabled": "true"

    # Security hardening
    # security_opt:
    #   - no-new-privileges:true
    #   - seccomp=seccomp.json
    # cap_drop:
    #   - ALL
    # cap_add:
    #   - NET_BIND_SERVICE
    #   - SYS_NICE
    #   - IPC_LOCK
    #   - CHOWN
    #   - DAC_OVERRIDE
    #   - SETUID
    #   - SETGID
    # tmpfs:
    #   - /tmp:size=1G,noexec,nosuid,nodev

    ports:
      - "8443:8443"     # HTTPS (external)
      - "9440:9440"     # Native TLS (external)

    # External configs and data
    volumes:
      - ./config/config.xml:/etc/clickhouse-server/config.xml:ro
      - ./config/users.xml:/etc/clickhouse-server/users.xml:ro
      - ./config/ch01/macros.xml:/etc/clickhouse-server/config.d/macros.xml:ro
      - ./config/config.d/s3.xml:/etc/clickhouse-server/config.d/s3.xml:ro
      - ./certs:/etc/clickhouse-server/certs:ro
      - ch01-data:/var/lib/clickhouse
      - ch01-log:/var/log/clickhouse-server

    # Resource limits
    deploy:
      resources:
        limits:
          memory: 16G
          cpus: "4"
        reservations:
          memory: 2G
          cpus: "1"

    # Health check
    healthcheck:
      test: ["CMD-SHELL", "clickhouse-client --user healthcheck --password 'healthcheck' --query 'SELECT 1' || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

    networks:
      - docker

    ulimits:
      nofile:
        soft: 262144
        hard: 262144

  ch02:
    image: clickhouse/clickhouse-server:26.1
    container_name: ch02
    hostname: ch02
    restart: unless-stopped
    labels:
      "docker-prometheus-exporter.metric.container_health.enabled": "true"

    # Security hardening
    # security_opt:
    #   - no-new-privileges:true
    #   - seccomp=seccomp.json
    # cap_drop:
    #   - ALL
    # cap_add:
    #   - NET_BIND_SERVICE
    #   - SYS_NICE
    #   - IPC_LOCK
    #   - CHOWN
    #   - DAC_OVERRIDE
    #   - SETUID
    #   - SETGID
    # tmpfs:
    #   - /tmp:size=1G,noexec,nosuid,nodev

    # External configs and data
    volumes:
      - ./config/config.xml:/etc/clickhouse-server/config.xml:ro
      - ./config/users.xml:/etc/clickhouse-server/users.xml:ro
      - ./config/ch02/macros.xml:/etc/clickhouse-server/config.d/macros.xml:ro
      - ./config/config.d/s3.xml:/etc/clickhouse-server/config.d/s3.xml:ro
      - ./certs:/etc/clickhouse-server/certs:ro
      - ch02-data:/var/lib/clickhouse
      - ch02-log:/var/log/clickhouse-server

    # Resource limits
    deploy:
      resources:
        limits:
          memory: 16G
          cpus: "4"
        reservations:
          memory: 2G
          cpus: "1"

    # Health check
    healthcheck:
      test: ["CMD-SHELL", "clickhouse-client --user healthcheck --password 'healthcheck' --query 'SELECT 1' || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

    networks:
      - docker

    ulimits:
      nofile:
        soft: 262144
        hard: 262144

  keeper01:
    image: clickhouse/clickhouse-keeper:26.1
    container_name: keeper01
    hostname: keeper01
    restart: unless-stopped
    labels:
      "docker-prometheus-exporter.metric.container_health.enabled": "true"

    # Security hardening
    # security_opt:
    #   - no-new-privileges:true
    # cap_drop:
    #   - ALL
    # cap_add:
    #   - NET_BIND_SERVICE
    #   - CHOWN
    #   - DAC_OVERRIDE
    #   - SETUID
    #   - SETGID
    # tmpfs:
    #   - /tmp:size=256M,noexec,nosuid,nodev

    volumes:
      - ./config/keeper01.xml:/etc/clickhouse-keeper/keeper_config.xml:ro
      - keeper01-data:/var/lib/clickhouse-keeper

    deploy:
      resources:
        limits:
          memory: 1G
          cpus: "1"
        reservations:
          memory: 256M
          cpus: "0.25"

    healthcheck:
      test: ["CMD-SHELL", "echo ruok | nc 127.0.0.1 9181 | grep -q imok || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

    networks:
      - docker

    ulimits:
      nofile:
        soft: 65536
        hard: 65536

  keeper02:
    image: clickhouse/clickhouse-keeper:26.1
    container_name: keeper02
    hostname: keeper02
    restart: unless-stopped
    labels:
      "docker-prometheus-exporter.metric.container_health.enabled": "true"

    # security_opt:
    #   - no-new-privileges:true
    # cap_drop:
    #   - ALL
    # cap_add:
    #   - NET_BIND_SERVICE
    #   - CHOWN
    #   - DAC_OVERRIDE
    #   - SETUID
    #   - SETGID
    # tmpfs:
    #   - /tmp:size=256M,noexec,nosuid,nodev

    volumes:
      - ./config/keeper02.xml:/etc/clickhouse-keeper/keeper_config.xml:ro
      - keeper02-data:/var/lib/clickhouse-keeper

    deploy:
      resources:
        limits:
          memory: 1G
          cpus: "1"
        reservations:
          memory: 256M
          cpus: "0.25"

    healthcheck:
      test: ["CMD-SHELL", "echo ruok | nc 127.0.0.1 9181 | grep -q imok || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

    networks:
      - docker

    ulimits:
      nofile:
        soft: 65536
        hard: 65536

  keeper03:
    image: clickhouse/clickhouse-keeper:26.1
    container_name: keeper03
    hostname: keeper03
    restart: unless-stopped
    labels:
      "docker-prometheus-exporter.metric.container_health.enabled": "true"

    # security_opt:
    #   - no-new-privileges:true
    # cap_drop:
    #   - ALL
    # cap_add:
    #   - NET_BIND_SERVICE
    #   - CHOWN
    #   - DAC_OVERRIDE
    #   - SETUID
    #   - SETGID
    # tmpfs:
    #   - /tmp:size=256M,noexec,nosuid,nodev

    volumes:
      - ./config/keeper03.xml:/etc/clickhouse-keeper/keeper_config.xml:ro
      - keeper03-data:/var/lib/clickhouse-keeper

    deploy:
      resources:
        limits:
          memory: 1G
          cpus: "1"
        reservations:
          memory: 256M
          cpus: "0.25"

    healthcheck:
      test: ["CMD-SHELL", "echo ruok | nc 127.0.0.1 9181 | grep -q imok || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

    networks:
      - docker

    ulimits:
      nofile:
        soft: 65536
        hard: 65536

volumes:
  keeper01-data:
    name: keeper01-data
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /app/docker/volumes/keeper01-data
  keeper02-data:
    name: keeper02-data
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /app/docker/volumes/keeper02-data
  keeper03-data:
    name: keeper03-data
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /app/docker/volumes/keeper03-data
  ch01-data:
    name: ch01-data
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /app/docker/volumes/ch01-data
  ch01-log:
    name: ch01-log
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /app/docker/volumes/ch01-log
  ch02-data:
    name: ch02-data
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /app/docker/volumes/ch02-data
  ch02-log:
    name: ch02-log
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /app/docker/volumes/ch02-log

networks:
  docker:
    external: true
